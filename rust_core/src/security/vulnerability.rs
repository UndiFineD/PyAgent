use pyo3::prelude::*;
use regex::Regex;

/// Scan code for security vulnerabilities (SecurityScannerAgent).
/// Returns Vec<(line_number, pattern_index, matched_text)>
#[pyfunction]
pub fn scan_code_vulnerabilities_rust(content: &str) -> PyResult<Vec<(usize, usize, String)>> {
    let patterns = [
        r"(?i)password\s*=\s*['][^']+[']",
        r"(?i)api_key\s*=\s*['][^']+[']",
        r"os\.system\s*\([^)]*\+",
        r"eval\s*\(",
        r"random\.(random|randint|choice)\s*\(",
        r"open\s*\([^)]*\+",
    ];
    
    let mut compiled: Vec<Regex> = Vec::new();
    for p in patterns {
        compiled.push(Regex::new(p).map_err(|e| pyo3::exceptions::PyValueError::new_err(e.to_string()))?);
    }
    
    let mut results = Vec::new();
    for (line_num, line) in content.lines().enumerate() {
        for (idx, re) in compiled.iter().enumerate() {
            if let Some(mat) = re.find(line) {
                results.push((line_num + 1, idx, mat.as_str().to_string()));
            }
        }
    }
    
    Ok(results)
}
