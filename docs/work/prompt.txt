# PyAgent Fleet Improvement Backlog
# Strategic focus: Rust conversion readiness + security hardening
# Last Updated: 2026-01-13

## COMPLETION PROGRESS

### Cycle 1-4 Accomplishments (DONE)
✅ Fixed 62 issues: circular imports, syntax errors, coroutine warnings
✅ Added return type hints to 55+ functions across 16 files
✅ Added module docstrings to 9 files
✅ Removed blocking I/O (time.sleep calls)
✅ Added context recording to 4 Core files
✅ Fixed YAML security vulnerability

### Cycle 5-10 Accomplishments (PHASE 4: DONE)
✅ Decomposed BaseAgent.py (51.4 KB) → BaseAgent.py + BaseAgentCore.py (10.1 KB)
✅ Extracted 13 pure logic methods to BaseAgentCore
✅ Decomposed metrics_engine.py (95.3 KB) → metrics_engine.py + MetricsCore.py (14.1 KB)
✅ Extracted 6 pure calculation classes to MetricsCore (381 lines)
✅ Fleet validation: All imports working, zero regressions
✅ Added 900+ lines of pure logic ready for Rust conversion

### Cycle 11 Accomplishments (PHASE 2: DONE)
✅ Fixed exec() vulnerability in run_fleet_self_improvement.py
✅ Fixed shell=True in HandyAgent.py (now uses shlex.split)
✅ Fixed os.popen() in EcosystemDiagnosticsAgent.py (now uses shutil.disk_usage)
✅ Fleet validation: 991 files scanned, 4 issues found (no regressions)
✅ Security hardening complete, ready for Phase 1 (Rust conversion)

### Latest Status (Cycle 14)
- Fleet scan: 991 files, 4 issues (2 auto-fixable)
- Vulnerability count: 0 (critical ones fixed in Phase 2)
- Code quality: 99.6% Ruff compliance
- Type coverage: ~70% of public APIs
- FormulaEngineCore: ✅ Complete (14 tests, 18.69 μs per call)
- ErrorMappingCore: ✅ Complete (21 tests, 0.141 μs per call)
- BenchmarkCore: ✅ Complete (20 tests, 0.177 μs per call)
- Phase 1 Progress: 3/20 Tier-1 Rust candidates fully tested and ready
- Next focus: Phase 1 Task 4 (BaseAgentCore Rust conversion)

---

## PHASE 1: RUST CONVERSION PREPARATION (CRITICAL PATH)

**Goal**: Prepare 20 Tier-1 Core files for Rust conversion

### FormulaEngineCore.py - ✅ COMPLETE
- Status: Python implementation validated with 14 comprehensive tests
- Python performance: 18.69 microseconds per call (simple operation)
- Expected Rust speedup: 10-50x
- Tasks completed:
  - [x] All return types annotated and verified
  - [x] 4 property-based tests created (hypothesis framework)
  - [x] 10 integration tests created for comprehensive coverage
  - [x] Python baseline benchmarked: 10,000 iterations in 0.187s
  - [x] Rust stub created with meval dependency (awaiting Rust build environment)
  - [x] PyO3 bindings prepared for evaluate_formula()
- Tests passing: 14/14 ✅ (unit + integration)
- Fleet validated: Cycle 13 passed (0 regressions)

### ErrorMappingCore.py - ✅ COMPLETE
- Status: Python implementation validated with 21 comprehensive tests
- Python performance: 0.141 microseconds per call
- Expected Rust speedup: 2-5x
- Tasks completed:
  - [x] All return types annotated and verified
  - [x] 21 property-based tests created (hypothesis + edge cases)
  - [x] Python baseline benchmarked: 100,000 iterations in 0.014s
  - [x] Rust stub created with match-based error code mapping
  - [x] PyO3 bindings prepared for get_error_code() + get_error_documentation_link()
- Tests passing: 21/21 ✅ (basics + property-based + edge cases)
- Fleet validated: Cycle 14 passed (0 regressions)
- Rust readiness: HIGH (pure enum lookup, zero I/O)

### BenchmarkCore.py - ✅ COMPLETE
- Status: Python implementation validated with 20 comprehensive tests
- Python performance: 0.177 microseconds per call
- Expected Rust speedup: 10-30x
- Tasks completed:
  - [x] All return types annotated and verified
  - [x] 20 property-based tests created (hypothesis + consistency checks)
  - [x] Python baseline benchmarked: 100,000 iterations in 0.018s
  - [x] Rust stub created with pure calculation functions
  - [x] PyO3 bindings prepared for calculate_baseline(), check_regression(), score_efficiency()
- Tests passing: 20/20 ✅ (basics + property-based + edge cases + consistency)
- Fleet validated: Cycle 14 passed (0 regressions)
- Rust readiness: CRITICAL (performance-intensive calculations)

### BaseAgentCore.py - HIGH VALUE ⭐⭐
- Status: Ready (pure logic extracted from BaseAgent)
- Expected speedup: 10-25x (anchoring/strategy calculations)
- Tasks:
  - [ ] Add property-based tests for anchoring/strategy
  - [ ] Implement Rust equivalent with PyO3 bindings
  - [ ] Benchmark Python vs Rust and wire into BaseAgent shell

### MetricsCore.py - HIGH VALUE ⭐⭐
- Status: Ready (TokenCost, ModelFallback, StatsRollup, ABTest cores)
- Expected speedup: 8-20x (analytics + cost calculation)
- Tasks:
  - [ ] Add hypothesis tests for token cost, rollups, AB significance
  - [ ] Implement Rust equivalent and expose via PyO3
  - [ ] Integrate with metrics_engine shell and benchmark

### TokenCostCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 5-20x
- Called frequently throughout system

### StabilityCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 5-15x
- Core fleet health monitoring

### TracingCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 3-10x
- Low-latency distributed tracing

### ProfilingCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 10-30x
- Profile analysis and optimization

**Remaining 11 Tier-1 files** (lower priority but still ready):
AutonomyCore, ConvergenceCore, IdentityCore, PruningCore, ResilienceCore, 
AuthCore, ModelFallbackCore, AuctionCore, ByzantineCore, PrivacyCore, 
DeduplicationCore

---

## PHASE 2: SECURITY HARDENING (COMPLETE ✅)

- All 4 critical vulnerabilities fixed (exec, shell=True x2, os.popen)
- Validated via Fleet Cycle 11 (991 files scanned, 0 new issues)
- Remaining security backlog moved to Phase 3:
  - Wildcard imports: management/final_fix.py line 46
  - File I/O atomicity rollout (30+ files, see backlog below)

### File I/O Atomicity Backlog (30+ files)
- Pattern: tempfile + atomic rename; rollback on error
- Targets: KnowledgeFusionAgent, MemoryConsolidator, SpeciationAgent, SynthesisAgent,
  VisualizerAgent, KnowledgeAgent, IdiomExtractorAgent, HierarchicalMemoryAgent,
  GraphMemoryAgent, GraphContextEngine, ResourceCurationAgent, TemporalPredictorAgent,
  QuantumMemoryAgent, FleetDeployerAgent, ModelForgeAgent, DependencyCore,
  ConvergenceCore, MultiModalContextAgent, GovernanceAgent, FeatureStoreAgent,
  SyntheticDataAgent, RefinementAgent, ToolEvolutionAgent, ToolSynthesisAgent,
  DocInferenceAgent, DeduplicationCore

---

## PHASE 3: CODE QUALITY HARDENING

### Replace print() with logging (50+ instances)
**Pattern:**
```python
from src.observability.logging import StructuredLogger
logger = StructuredLogger(__name__)
logger.info("message")  # Not print("message")
```

Files to update (23 files):
ConfigHotReloader, RequestRecorder, SystemAnalytics, HopperSim,
BrokenImportAgent, StatsAgent, ReportingAgent, metrics_engine,
MetricsExporter, OTelManager, ReportValidator, report_generator,
ReportGenerator, AgentBus, MultiCloudBridgeOrchestrator, RLSelector,
SwarmPruningOrchestrator, WeightOrchestrator, BranchComparer,
AutoDebuggerOrchestrator, FleetManager, KubernetesManager, CloudSwarmManager

### Fix broad exception handlers (30+ files)
Replace `except Exception:` with specific types:
```python
# Bad
except Exception:
    pass

# Good
except (FileNotFoundError, JSONDecodeError, TimeoutError):
    logger.error("Specific error occurred")
    raise
```

Files to fix:
SelfHealingCore, FleetExecutionCore, QuantumShardOrchestrator, 
StatsStreamManager, StatsSubscriptionManager, environment, utils,
PhaseOrchestrator, GraphCore, FleetManager, SLAManager, scheduling,
KnowledgeAgent, ArchitectAgent, HandyAgent, CircuitBreaker,
ImprovementsAgent, ReportAPI, AgentAPIServer, StatsQueryEngine, FormulaEngineCore

### Add missing return type hints (5+ functions)
- [ ] HopperSim.run_swarm_stress_test() → None
- [ ] EvolutionCore.perform_specialized_task() → Any
- [ ] SpeciationAgent.setUp() → None
- [ ] SpeciationAgent.test_initialization() → None

### Add missing class docstrings (24 classes)
Required format:
```python
class MyClass:
    """Brief description.
    
    Longer description if needed.
    """
```

Classes needing docstrings:
FormulaEngine, TokenCostCore, TokenCostEngine, ModelFallbackCore,
ModelFallbackEngine, StatsRollupCalculator, StatsForecaster, ABComparator,
ResourceMonitor, MemoryCore, SecretCore, TenantCore, BrokenAgent,
FutureAgent, AgentFixture, FileFixture, EcosystemDiagnosticsAgent,
APICore, TelemetryManager

---

## PHASE 4: LARGE FILE DECOMPOSITION

### Completed
- [x] BaseAgent.py decomposed → BaseAgent.py + BaseAgentCore.py (Core/Shell)
- [x] metrics_engine.py decomposed → metrics_engine.py + MetricsCore.py (Core/Shell)

### Remaining Targets
- OrchestratorAgent.py (44 KB): Analyze for Core/Shell split
- SelfImprovementOrchestrator.py (32 KB): Analyze for Core/Shell split

---

## PHASE 5: DOCUMENTATION & MAINTENANCE

### Fix TODO/FIXME comments (3 actionable)
- [ ] VisionCore.py line 29: Implement pixel analysis (TODO in docstring)
- [ ] acceleration.py line 34: Update Rust core import path
- [ ] delegation.py line 71: Move to centralized ModuleLoader

### Fix naming issues (1 typo)
- [ ] AgentAPIServer.py line 49: TelemetryManger → TelemetryManager

### Add missing module docstrings (3 files)
- [ ] ArchitectAgent.py
- [ ] observability/reports/utils.py
- [ ] FleetExecutionCore.py

---

## SUCCESS CRITERIA

### Phase 1 (Rust Conversion)
- ✅ 20 Tier-1 Core files identified and ready
- ⏳ FormulaEngineCore converted and benchmarked
- ⏳ ErrorMappingCore deployed to rust_core
- ⏳ BenchmarkCore performance validated
- **Target**: 20-40% performance gain for computational workloads

### Phase 2 (Security)
- ✅ All 4 critical vulnerabilities fixed
- ⏳ 30+ files updated with atomic writes
- **Target**: Zero critical vulnerabilities

### Phase 3 (Quality)
- ⏳ 50+ print statements replaced with logging
- ⏳ 30+ broad exception handlers made specific
- ⏳ 5 missing return types added
- ⏳ 24 class docstrings added
- **Target**: 99.9% code quality metrics

### Phase 4 (Architecture)
- ⏳ BaseAgent.py decomposed to <20KB files
- ⏳ metrics_engine.py decomposed to <30KB files
- **Target**: All files <30KB for maintainability

### Phase 5 (Maintenance)
- ⏳ All TODO/FIXME resolved
- ⏳ Naming consistency 100%
- ⏳ Documentation coverage 95%+

---

## EXECUTION INSTRUCTIONS

### For Fleet Script
Run with dual directives:
```bash
python src/infrastructure/dev/scripts/run_fleet_self_improvement.py \
  -p docs/work/prompt.txt \
  -t docs/work/context.txt
```

### For Manual Tasks
1. Read this file first (you're here)
2. Check context.txt for strategic guidance
3. Check RUST_Ready.md for conversion catalog
4. Start with Phase 1 tasks (Rust conversion)
5. Then Phase 2 (Security)
6. Then remaining phases in order

### Progress Tracking
- Mark items as [ ] uncompleted or [x] completed
- Update this file after each completed batch
- Run fleet scan after major changes: `python run_fleet_self_improvement.py -p docs/work/prompt.txt`
- Archive old versions as prompt-oldN.txt

---

## QUICK REFERENCE

**Most Urgent** (Start here):
1. Convert FormulaEngineCore to Rust
2. Convert ErrorMappingCore to Rust
3. Add atomic write pattern to backlog files

**High Value** (Then):
1. Replace 50+ print statements
2. Fix 30+ exception handlers
3. Convert BenchmarkCore, TokenCostCore, MetricsCore, BaseAgentCore to Rust

**Important** (Ongoing):
1. Add 24 missing docstrings
2. Atomic write pattern to 30+ files
3. Convert remaining Tier-1 Core files

**Maintenance** (As needed):
1. Fix 3 TODO comments
2. Fix naming typo
3. Add 3 module docstrings
4. Update documentation



