# PyAgent Fleet Improvement Backlog
# Strategic focus: Rust conversion readiness + security hardening
# Last Updated: 2026-01-13

## COMPLETION PROGRESS

### Cycle 1-4 Accomplishments (DONE)
✅ Fixed 62 issues: circular imports, syntax errors, coroutine warnings
✅ Added return type hints to 55+ functions across 16 files
✅ Added module docstrings to 9 files
✅ Removed blocking I/O (time.sleep calls)
✅ Added context recording to 4 Core files
✅ Fixed YAML security vulnerability

### Cycle 5 Status (CURRENT)
- Latest fleet scan: 989 files, 4 issues found (2 auto-fixed)
- Code quality: 99.6% Ruff compliance
- Type coverage: ~70% of public APIs
- Next focus: Rust conversion prep + security hardening

---

## PHASE 1: RUST CONVERSION PREPARATION (CRITICAL PATH)

**Goal**: Prepare 18 Tier-1 Core files for Rust conversion

### FormulaEngineCore.py - HIGHEST PRIORITY ⭐⭐⭐
- Status: Ready for conversion (pure logic, no I/O)
- Expected speedup: 10-50x
- Tasks:
  - [ ] Ensure all return types are annotated
  - [ ] Write property-based tests using hypothesis
  - [ ] Extract to separate file if needed
  - [ ] Create Rust equivalent with PyO3
  - [ ] Benchmark Python vs Rust
  - [ ] Deploy to rust_core module

### ErrorMappingCore.py - CRITICAL ⭐⭐⭐
- Status: Ready (dict-based error mappings)
- Expected speedup: 2-5x
- Used everywhere in codebase
- Tasks:
  - [ ] Ensure complete type annotations
  - [ ] Test all error codes mapped correctly
  - [ ] Create Rust enum equivalent
  - [ ] Add to rust_core with bindings

### BenchmarkCore.py - CRITICAL ⭐⭐⭐
- Status: Ready (dataclass calculations)
- Expected speedup: 10-30x
- Tasks:
  - [ ] Verify all calculations type-safe
  - [ ] Write benchmark test suite
  - [ ] Create Rust implementation
  - [ ] Validate identical output

### TokenCostCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 5-20x
- Called frequently throughout system

### StabilityCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 5-15x
- Core fleet health monitoring

### TracingCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 3-10x
- Low-latency distributed tracing

### ProfilingCore.py - HIGH VALUE ⭐⭐
- Expected speedup: 10-30x
- Profile analysis and optimization

**Remaining 11 Tier-1 files** (lower priority but still ready):
AutonomyCore, ConvergenceCore, IdentityCore, PruningCore, ResilienceCore, 
AuthCore, ModelFallbackCore, AuctionCore, ByzantineCore, PrivacyCore, 
DeduplicationCore

---

## PHASE 2: SECURITY HARDENING (URGENT)

### Critical Vulnerabilities (4 items)
1. [ ] **exec() in run_fleet_self_improvement.py** (line 122)
   - Remove exec() completely
   - Use ast.literal_eval() for safe operations only
   - Add explicit whitelist for directive operations
   
2. [ ] **shell=True in subprocess** (2 instances)
   - run_fleet_self_improvement.py line 111
   - HandyAgent.py line 118
   - Replace with list-based subprocess.run()
   - Add input validation layer
   
3. [ ] **Wildcard imports** (1 instance)
   - management/final_fix.py line 46
   - Replace with explicit imports
   
4. [ ] **Hardcoded paths** (ConfigurationManager.py)
   - Move to environment variables
   - Use pathlib.Path for cross-platform safety

### File I/O Atomicity (30+ files)
**Pattern to implement:**
```python
import tempfile
import shutil
from pathlib import Path

# Safe atomic write
with tempfile.NamedTemporaryFile(mode='w', dir=Path(target).parent, 
                                 delete=False) as tmp:
    # Write data to temp
    tmp.write(data)
    tmp_path = tmp.name

try:
    # Atomic move
    shutil.move(tmp_path, target)
except Exception as e:
    Path(tmp_path).unlink(missing_ok=True)
    raise
```

Files needing atomic writes:
KnowledgeFusionAgent, MemoryConsolidator, SpeciationAgent, SynthesisAgent,
VisualizerAgent, KnowledgeAgent, IdiomExtractorAgent, HierarchicalMemoryAgent,
GraphMemoryAgent, GraphContextEngine, ResourceCurationAgent, 
TemporalPredictorAgent, QuantumMemoryAgent, FleetDeployerAgent, ModelForgeAgent,
DependencyCore, ConvergenceCore, MultiModalContextAgent, GovernanceAgent,
FeatureStoreAgent, SyntheticDataAgent, RefinementAgent, ToolEvolutionAgent,
ToolSynthesisAgent, DocInferenceAgent, DeduplicationCore

---

## PHASE 3: CODE QUALITY HARDENING

### Replace print() with logging (50+ instances)
**Pattern:**
```python
from src.observability.logging import StructuredLogger
logger = StructuredLogger(__name__)
logger.info("message")  # Not print("message")
```

Files to update (23 files):
ConfigHotReloader, RequestRecorder, SystemAnalytics, HopperSim,
BrokenImportAgent, StatsAgent, ReportingAgent, metrics_engine,
MetricsExporter, OTelManager, ReportValidator, report_generator,
ReportGenerator, AgentBus, MultiCloudBridgeOrchestrator, RLSelector,
SwarmPruningOrchestrator, WeightOrchestrator, BranchComparer,
AutoDebuggerOrchestrator, FleetManager, KubernetesManager, CloudSwarmManager

### Fix broad exception handlers (30+ files)
Replace `except Exception:` with specific types:
```python
# Bad
except Exception:
    pass

# Good
except (FileNotFoundError, JSONDecodeError, TimeoutError):
    logger.error("Specific error occurred")
    raise
```

Files to fix:
SelfHealingCore, FleetExecutionCore, QuantumShardOrchestrator, 
StatsStreamManager, StatsSubscriptionManager, environment, utils,
PhaseOrchestrator, GraphCore, FleetManager, SLAManager, scheduling,
KnowledgeAgent, ArchitectAgent, HandyAgent, CircuitBreaker,
ImprovementsAgent, ReportAPI, AgentAPIServer, StatsQueryEngine, FormulaEngineCore

### Add missing return type hints (5+ functions)
- [ ] HopperSim.run_swarm_stress_test() → None
- [ ] EvolutionCore.perform_specialized_task() → Any
- [ ] SpeciationAgent.setUp() → None
- [ ] SpeciationAgent.test_initialization() → None

### Add missing class docstrings (24 classes)
Required format:
```python
class MyClass:
    """Brief description.
    
    Longer description if needed.
    """
```

Classes needing docstrings:
FormulaEngine, TokenCostCore, TokenCostEngine, ModelFallbackCore,
ModelFallbackEngine, StatsRollupCalculator, StatsForecaster, ABComparator,
ResourceMonitor, MemoryCore, SecretCore, TenantCore, BrokenAgent,
FutureAgent, AgentFixture, FileFixture, EcosystemDiagnosticsAgent,
APICore, TelemetryManager

---

## PHASE 4: LARGE FILE DECOMPOSITION

### BaseAgent.py (51.2 KB) - CRITICAL BLOCKER
- [ ] Extract pure validation logic → BaseAgentCore
- [ ] Extract state management → BaseAgentCore
- [ ] Keep orchestration/I/O in BaseAgent shell
- [ ] Target size: <20KB per file
- [ ] Estimate: 20-30 hours of refactoring

### metrics_engine.py (97.4 KB) - CRITICAL BLOCKER
- [ ] Extract calculation logic → MetricsCore
- [ ] Extract formula processing → extends FormulaEngineCore
- [ ] Keep reporting/export in shell
- [ ] Target size: <30KB per file
- [ ] Estimate: 25-35 hours of refactoring

### OrchestratorAgent.py (44 KB)
- [ ] Analyze for Core/Shell split
- [ ] Estimate complexity

### SelfImprovementOrchestrator.py (32 KB)
- [ ] Analyze for Core/Shell split
- [ ] Estimate complexity

---

## PHASE 5: DOCUMENTATION & MAINTENANCE

### Fix TODO/FIXME comments (3 actionable)
- [ ] VisionCore.py line 29: Implement pixel analysis (TODO in docstring)
- [ ] acceleration.py line 34: Update Rust core import path
- [ ] delegation.py line 71: Move to centralized ModuleLoader

### Fix naming issues (1 typo)
- [ ] AgentAPIServer.py line 49: TelemetryManger → TelemetryManager

### Add missing module docstrings (3 files)
- [ ] ArchitectAgent.py
- [ ] observability/reports/utils.py
- [ ] FleetExecutionCore.py

---

## SUCCESS CRITERIA

### Phase 1 (Rust Conversion)
- ✅ 18 Tier-1 Core files identified and ready
- ⏳ FormulaEngineCore converted and benchmarked
- ⏳ ErrorMappingCore deployed to rust_core
- ⏳ BenchmarkCore performance validated
- **Target**: 20-40% performance gain for computational workloads

### Phase 2 (Security)
- ⏳ All 4 critical vulnerabilities fixed
- ⏳ 30+ files updated with atomic writes
- **Target**: Zero critical vulnerabilities

### Phase 3 (Quality)
- ⏳ 50+ print statements replaced with logging
- ⏳ 30+ broad exception handlers made specific
- ⏳ 5 missing return types added
- ⏳ 24 class docstrings added
- **Target**: 99.9% code quality metrics

### Phase 4 (Architecture)
- ⏳ BaseAgent.py decomposed to <20KB files
- ⏳ metrics_engine.py decomposed to <30KB files
- **Target**: All files <30KB for maintainability

### Phase 5 (Maintenance)
- ⏳ All TODO/FIXME resolved
- ⏳ Naming consistency 100%
- ⏳ Documentation coverage 95%+

---

## EXECUTION INSTRUCTIONS

### For Fleet Script
Run with dual directives:
```bash
python src/infrastructure/dev/scripts/run_fleet_self_improvement.py \
  -p docs/work/prompt.txt \
  -t docs/work/context.txt
```

### For Manual Tasks
1. Read this file first (you're here)
2. Check context.txt for strategic guidance
3. Check RUST_Ready.md for conversion catalog
4. Start with Phase 1 tasks (Rust conversion)
5. Then Phase 2 (Security)
6. Then remaining phases in order

### Progress Tracking
- Mark items as [ ] uncompleted or [x] completed
- Update this file after each completed batch
- Run fleet scan after major changes: `python run_fleet_self_improvement.py -p docs/work/prompt.txt`
- Archive old versions as prompt-oldN.txt

---

## QUICK REFERENCE

**Most Urgent** (Start here):
1. Fix 4 security vulnerabilities
2. Convert FormulaEngineCore to Rust
3. Decompose BaseAgent.py

**High Value** (Then):
1. Replace 50+ print statements
2. Fix 30+ exception handlers
3. Convert ErrorMappingCore to Rust

**Important** (Ongoing):
1. Add 24 missing docstrings
2. Atomic write pattern to 30+ files
3. Convert remaining Tier-1 Core files

**Maintenance** (As needed):
1. Fix 3 TODO comments
2. Fix naming typo
3. Add 3 module docstrings
4. Update documentation



