<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyAgent Manifest Designer</title>
    <script src="/static/assets/tailwind.js"></script>
    <link href="/static/assets/fontawesome.min.css" rel="stylesheet">
    <style>
        .skill-node { cursor: grab; }
        .skill-node:active { cursor: grabbing; }
        .node-active { border-color: #3b82f6 !important; background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="bg-gray-900 text-white font-mono">
    <div class="flex h-screen">
        <!-- Sidebar: Node Gallery -->
        <div class="w-72 bg-gray-800 p-4 border-r border-gray-700 flex flex-col">
            <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                <i class="fas fa-cubes"></i> Node Gallery
            </h2>
            
            <div class="mb-6">
                <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest">Cognitive Units</p>
                <div id="palette" class="space-y-2">
                    <div draggable="true" ondragstart="drag(event)" data-type="task" data-skill="research" class="skill-node p-3 bg-gray-700 rounded-lg hover:bg-gray-600 border border-gray-600 transition-colors">
                        <i class="fas fa-search mr-2 text-blue-400"></i>Research Node
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="task" data-skill="coder" class="skill-node p-3 bg-gray-700 rounded-lg hover:bg-gray-600 border border-gray-600 transition-colors">
                        <i class="fas fa-code mr-2 text-emerald-400"></i>Coder Node
                    </div>
                    <div draggable="true" ondragstart="drag(event)" data-type="condition" data-skill="logic" class="skill-node p-3 bg-gray-700 rounded-lg hover:bg-gray-600 border border-gray-600 transition-colors">
                        <i class="fas fa-code-branch mr-2 text-amber-400"></i>Logic Branch
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-auto">
                <div class="flex border-b border-gray-700 mb-2">
                    <button id="tab-node" onclick="showTab('node')" class="flex-1 py-2 text-[10px] font-bold uppercase border-b-2 border-blue-500 text-blue-400">Node Config</button>
                    <button id="tab-global" onclick="showTab('global')" class="flex-1 py-2 text-[10px] font-bold uppercase border-b-2 border-transparent text-gray-500 hover:text-gray-300">Global Config</button>
                </div>

                <div id="node-config-section">
                    <div id="config-panel" class="p-4 bg-gray-900/50 rounded-lg border border-gray-700 hidden">
                        <label id="prompt-label" class="text-[10px] text-gray-500">PROMPT_TEMPLATE</label>
                        <textarea id="node-prompt" class="w-full h-24 bg-gray-800 border border-gray-600 rounded p-2 text-xs mt-1 outline-none focus:border-blue-500" oninput="updateNodeConfig()"></textarea>
                        
                        <div id="branch-config" class="mt-4 hidden">
                            <label class="text-[10px] text-orange-500 font-bold">IF_TRUE_TARGET (Node ID)</label>
                            <input id="target-true" type="text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-xs mt-1 outline-none" oninput="updateNodeConfig()">
                            
                            <label class="text-[10px] text-gray-500 font-bold mt-2 block">IF_FALSE_TARGET (Node ID)</label>
                            <input id="target-false" type="text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-xs mt-1 outline-none" oninput="updateNodeConfig()">
                        </div>

                        <div id="node-next-config" class="mt-4">
                            <label class="text-[10px] text-gray-500">NEXT_NODE_ID</label>
                            <input id="node-next" type="text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-xs mt-1 outline-none" oninput="updateNodeConfig()">
                        </div>

                        <label class="text-[10px] text-gray-500 mt-4 block">NODE_ID</label>
                        <input id="node-id-val" type="text" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-[10px] mt-1 outline-none opacity-50" readonly>
                    </div>
                    <div id="no-config" class="text-center py-10 text-gray-600 text-xs italic">
                        Select a node to configure
                    </div>
                </div>

                <div id="global-config-section" class="hidden p-4 space-y-4">
                    <div>
                        <label class="text-[10px] text-gray-500 uppercase font-bold">Required Skills (CSV)</label>
                        <input id="global-skills" type="text" value="orchestration" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-xs mt-1 outline-none" oninput="syncState()">
                    </div>
                    
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Permissions</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 text-xs text-gray-400">
                                <input type="checkbox" id="perm-fs-read" checked onchange="syncState()"> FS_READ
                            </label>
                            <label class="flex items-center gap-2 text-xs text-gray-400">
                                <input type="checkbox" id="perm-fs-write" onchange="syncState()"> FS_WRITE
                            </label>
                            <label class="flex items-center gap-2 text-xs text-gray-400">
                                <input type="checkbox" id="perm-network" checked onchange="syncState()"> NETWORK
                            </label>
                            <label class="flex items-center gap-2 text-xs text-gray-400">
                                <input type="checkbox" id="perm-execution" onchange="syncState()"> EXECUTION
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Canvas -->
        <div class="flex-1 flex flex-col">
            <header class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center shadow-2xl z-10">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-black bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent uppercase">Industrial Factory Shard Designer</h1>
                    <span class="px-2 py-1 bg-blue-500/10 text-blue-400 text-[10px] font-bold rounded border border-blue-500/20">v4.0.0-DAG</span>
                </div>
                <div class="space-x-3">
                    <button onclick="clearCanvas()" class="px-4 py-2 border border-red-500/30 text-red-400 text-sm rounded-lg hover:bg-red-500/10 transition-all">Reset</button>
                    <button onclick="previewManifest()" class="px-4 py-2 bg-gray-700 text-sm rounded-lg hover:bg-gray-600 transition-all">Preview JSON</button>
                    <button onclick="saveManifest()" class="px-6 py-2 bg-blue-600 text-sm rounded-lg hover:bg-blue-500 font-bold shadow-lg shadow-blue-500/20 transition-all">Compile & Deploy</button>
                </div>
            </header>
            
            <div id="canvas" ondrop="drop(event)" ondragover="allowDrop(event)" class="flex-1 p-10 grid grid-cols-4 gap-6 overflow-auto bg-[radial-gradient(#2d3748_1px,transparent_1px)] [background-size:24px_24px] relative">
                <!-- Dropped skills will appear here -->
            </div>

            <footer class="p-4 bg-gray-900 border-t border-gray-700 flex gap-8 items-end shadow-[0_-10px_20px_rgba(0,0,0,0.3)]">
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-gray-600 uppercase">Evolutionary Role</label>
                    <input id="role-name" type="text" value="autonomous_workflow" class="bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg text-blue-400 font-bold focus:border-blue-500 outline-none w-64 shadow-inner">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-gray-600 uppercase">Cognitive Engine</label>
                    <select id="reasoning-mode" class="bg-gray-800 border border-gray-700 px-3 py-2 rounded-lg text-gray-300 outline-none w-48 shadow-inner">
                        <option value="cort">CoRT (Recursive)</option>
                        <option value="cot">Standard (CoT)</option>
                        <option value="react">ReAct (Loop)</option>
                    </select>
                </div>
                <div class="flex-1 text-right">
                    <p class="text-[10px] text-gray-500">Nodes: <span id="node-count" class="text-blue-400">0</span> | Connectors: <span id="conn-count" class="text-blue-400">0</span></p>
                </div>
            </footer>
        </div>
    </div>

    <script>
        let manifest = {
            version: "1.0.0",
            role: "autonomous_workflow",
            description: "Industrial Factory Shard",
            required_skills: ["orchestration"],
            reasoning_mode: "cort",
            flow_nodes: [],  // Pillar 4
            connectors: []   // Pillar 4
        };

        let selectedNodeId = null;

        function allowDrop(ev) { ev.preventDefault(); }

        function drag(ev) {
            ev.dataTransfer.setData("type", ev.target.getAttribute("data-type"));
            ev.dataTransfer.setData("skill", ev.target.getAttribute("data-skill"));
            ev.dataTransfer.setData("text", ev.target.innerText);
        }

        function drop(ev) {
            ev.preventDefault();
            const type = ev.dataTransfer.getData("type");
            const skill = ev.dataTransfer.getData("skill");
            const name = ev.dataTransfer.getData("text");
            
            const newNodeId = `node_${manifest.flow_nodes.length + 1}`;
            
            const newNode = {
                id: newNodeId,
                type: type,
                skill: skill,
                name: name,
                prompt: `Execute ${name} with standard context.`,
                logic: type === "condition" ? "True" : ""
            };
            
            manifest.flow_nodes.push(newNode);
            renderNode(newNode);
            updateStats();
        }

        function renderNode(node) {
            const el = document.createElement("div");
            el.id = `ui-${node.id}`;
            el.onclick = () => selectNode(node.id);
            el.className = "group p-5 bg-gray-800/80 backdrop-blur-md border border-gray-700 rounded-xl shadow-2xl hover:scale-105 transition-all cursor-pointer relative overflow-hidden flex flex-col justify-between h-32";
            el.innerHTML = `
                <div class="absolute top-0 left-0 w-1 h-full ${node.type === 'condition' ? 'bg-amber-500' : 'bg-blue-500'}"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-black text-xs text-white uppercase tracking-tighter">${node.name}</h3>
                        <p class="text-[9px] text-gray-500 font-mono">${node.id}</p>
                    </div>
                    <button onclick="removeNode('${node.id}', event)" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mt-auto flex gap-1">
                    <span class="text-[8px] bg-gray-900 border border-gray-700 px-1 rounded text-gray-500 uppercase">${node.type}</span>
                </div>
            `;
            document.getElementById("canvas").appendChild(el);
        }

        function selectNode(id) {
            selectedNodeId = id;
            document.querySelectorAll("#canvas > div").forEach(el => el.classList.remove("node-active"));
            document.getElementById(`ui-${id}`).classList.add("node-active");
            
            const node = manifest.flow_nodes.find(n => n.id === id);
            document.getElementById("config-panel").classList.remove("hidden");
            document.getElementById("no-config").classList.add("hidden");
            document.getElementById("node-id-val").value = id;
            document.getElementById("node-prompt").value = (node.type === "condition" ? node.logic : node.prompt) || "";
            
            // Toggle visibility of branch vs next
            if(node.type === "condition") {
                document.getElementById("branch-config").classList.remove("hidden");
                document.getElementById("node-next-config").classList.add("hidden");
                document.getElementById("prompt-label").innerText = "PYTHON_LOGIC";
                
                const trueConn = manifest.connectors.find(c => c.from === id && c.label === "if_true");
                const falseConn = manifest.connectors.find(c => c.from === id && c.label === "if_false");
                document.getElementById("target-true").value = trueConn ? trueConn.to : "";
                document.getElementById("target-false").value = falseConn ? falseConn.to : "";
            } else {
                document.getElementById("branch-config").classList.add("hidden");
                document.getElementById("node-next-config").classList.remove("hidden");
                document.getElementById("prompt-label").innerText = "PROMPT_TEMPLATE";
                
                const nextConn = manifest.connectors.find(c => c.from === id && !c.label);
                document.getElementById("node-next").value = nextConn ? nextConn.to : "";
            }
        }

        function updateNodeConfig() {
            const val = document.getElementById("node-prompt").value;
            const node = manifest.flow_nodes.find(n => n.id === selectedNodeId);
            if(node.type === "condition") node.logic = val;
            else node.prompt = val;

            // Update connectors
            manifest.connectors = manifest.connectors.filter(c => c.from !== selectedNodeId);
            if(node.type === "condition") {
                const targetTrue = document.getElementById("target-true").value;
                const targetFalse = document.getElementById("target-false").value;
                if(targetTrue) manifest.connectors.push({from: selectedNodeId, to: targetTrue, label: "if_true"});
                if(targetFalse) manifest.connectors.push({from: selectedNodeId, to: targetFalse, label: "if_false"});
            } else {
                const nextId = document.getElementById("node-next").value;
                if(nextId) manifest.connectors.push({from: selectedNodeId, to: nextId});
            }
            updateStats();
        }

        function removeNode(id, ev) {
            if(ev) ev.stopPropagation();
            manifest.flow_nodes = manifest.flow_nodes.filter(n => n.id !== id);
            manifest.connectors = manifest.connectors.filter(c => c.from !== id && c.to !== id);
            document.getElementById(`ui-${id}`).remove();
            if(selectedNodeId === id) {
                document.getElementById("config-panel").classList.add("hidden");
                document.getElementById("no-config").classList.remove("hidden");
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById("node-count").innerText = manifest.flow_nodes.length;
            document.getElementById("conn-count").innerText = manifest.connectors.length;
        }

        function clearCanvas() {
            manifest.flow_nodes = [];
            manifest.connectors = [];
            document.getElementById("canvas").innerHTML = "";
            updateStats();
        }

        function showTab(tab) {
            if(tab === 'node') {
                document.getElementById('node-config-section').classList.remove('hidden');
                document.getElementById('global-config-section').classList.add('hidden');
                document.getElementById('tab-node').classList.add('border-blue-500', 'text-blue-400');
                document.getElementById('tab-global').classList.remove('border-blue-500', 'text-blue-400');
                document.getElementById('tab-global').classList.add('border-transparent', 'text-gray-500');
            } else {
                document.getElementById('node-config-section').classList.add('hidden');
                document.getElementById('global-config-section').classList.remove('hidden');
                document.getElementById('tab-global').classList.add('border-blue-500', 'text-blue-400');
                document.getElementById('tab-node').classList.remove('border-blue-500', 'text-blue-400');
                document.getElementById('tab-node').classList.add('border-transparent', 'text-gray-500');
            }
        }

        function syncState() {
            manifest.role = document.getElementById("role-name").value;
            manifest.reasoning_mode = document.getElementById("reasoning-mode").value;
            manifest.required_skills = document.getElementById("global-skills").value.split(',').map(s => s.trim()).filter(s => s);
            manifest.permissions = {
                fs_read: document.getElementById("perm-fs-read").checked,
                fs_write: document.getElementById("perm-fs-write").checked,
                network: document.getElementById("perm-network").checked,
                execution: document.getElementById("perm-execution").checked
            };
        }

        function previewManifest() {
            syncState();
            const win = window.open("", "_blank");
            win.document.write(`<pre style="background:#0f172a;color:#94a3b8;padding:20px;font-family:monospace;">${JSON.stringify(manifest, null, 4)}</pre>`);
        }

        async function saveManifest() {
            syncState();
            try {
                const response = await fetch('/manifest/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(manifest)
                });
                const result = await response.json();
                alert(`PYAGENT_DEPLOY: Combined Unity Shard [${result.role}] compiled into manifest repository.`);
            } catch (e) {
                alert(`DEPLOY_ERROR: Communication with repository failed: ${e}`);
            }
        }
    </script>
</body>
</html>
