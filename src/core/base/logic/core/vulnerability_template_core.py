#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import re
import requests
from typing import Dict, List, Optional, Any
from dataclasses import dataclass
import json

@dataclass
class VulnerabilityTemplate:
    """Template for vulnerability detection."""
    id: str
    name: str
    severity: str
    description: str
    tags: List[str]
    classification: Dict[str, Any]
    matchers: List[Dict]
    info: Dict[str, Any]

class VulnerabilityTemplateCore:
    """Core for managing and executing vulnerability detection templates."""
    
    def __init__(self):
        self.templates: Dict[str, VulnerabilityTemplate] = {}
        self.load_default_templates()

    def load_default_templates(self):
        """Load common vulnerability detection templates."""
        # XSS Template
        self.templates["xss-basic"] = VulnerabilityTemplate(
            id="xss-basic",
            name="Basic XSS Detection",
            severity="medium",
            description="Detects basic XSS patterns in responses",
            tags=["xss", "injection"],
            classification={"cve-id": None, "cwe-id": "CWE-79"},
            matchers=[
                {
                    "type": "word",
                    "words": ["<script>", "javascript:", "onload=", "onerror="],
                    "part": "body"
                }
            ],
            info={"name": "Basic XSS", "author": "PyAgent", "severity": "medium"}
        )
        
        # SQL Injection Template
        self.templates["sqli-basic"] = VulnerabilityTemplate(
            id="sqli-basic",
            name="Basic SQL Injection Detection",
            severity="high",
            description="Detects SQL error patterns",
            tags=["sqli", "database"],
            classification={"cve-id": None, "cwe-id": "CWE-89"},
            matchers=[
                {
                    "type": "word",
                    "words": ["SQL syntax", "mysql_fetch", "ORA-", "PostgreSQL"],
                    "part": "body"
                }
            ],
            info={"name": "SQL Injection", "author": "PyAgent", "severity": "high"}
        )
        
        # Host Header Attack Template (from active-scan-plus-plus)
        self.templates["host-header-attack"] = VulnerabilityTemplate(
            id="host-header-attack",
            name="Host Header Attack Detection",
            severity="medium",
            description="Detects potential host header vulnerabilities (password reset poisoning, cache poisoning)",
            tags=["host-header", "web", "poisoning"],
            classification={"cve-id": None, "cwe-id": "CWE-116"},
            matchers=[
                {
                    "type": "word",
                    "words": ["host", "Host", "HOST"],
                    "part": "header",
                    "condition": "header_manipulation"
                }
            ],
            info={"name": "Host Header Attack", "author": "active-scan-plus-plus", "severity": "medium"}
        )

        # Shellshock (CVE-2014-6271) Template
        self.templates["shellshock"] = VulnerabilityTemplate(
            id="shellshock",
            name="Shellshock Detection",
            severity="critical",
            description="Detects Shellshock vulnerability in CGI applications",
            tags=["shellshock", "cgi", "bash", "rce"],
            classification={"cve-id": "CVE-2014-6271", "cwe-id": "CWE-78"},
            matchers=[
                {
                    "type": "regex",
                    "regex": ["\\(\\s*\\)\\s*\\{", "\\(\\s*\\)\\s*\\{.*;.*\\}"],
                    "part": "body"
                }
            ],
            info={"name": "Shellshock", "author": "active-scan-plus-plus", "severity": "critical"}
        )

        # Log4Shell (CVE-2021-44228) Template
        self.templates["log4shell"] = VulnerabilityTemplate(
            id="log4shell",
            name="Log4Shell Detection",
            severity="critical",
            description="Detects Log4Shell vulnerability in Java applications",
            tags=["log4j", "log4shell", "java", "rce"],
            classification={"cve-id": "CVE-2021-44228", "cwe-id": "CWE-502"},
            matchers=[
                {
                    "type": "regex",
                    "regex": ["\\$\\{.*\\}", "log4j", "apache.logging.log4j"],
                    "part": "body"
                }
            ],
            info={"name": "Log4Shell", "author": "active-scan-plus-plus", "severity": "critical"}
        )

        # Edge Side Includes (ESI) Template
        self.templates["esi-injection"] = VulnerabilityTemplate(
            id="esi-injection",
            name="ESI Injection Detection",
            severity="high",
            description="Detects Edge Side Includes injection vulnerabilities",
            tags=["esi", "injection", "cdn"],
            classification={"cve-id": None, "cwe-id": "CWE-79"},
            matchers=[
                {
                    "type": "regex",
                    "regex": ["<esi:.*>", "<esi:include", "<esi:eval"],
                    "part": "body"
                }
            ],
            info={"name": "ESI Injection", "author": "active-scan-plus-plus", "severity": "high"}
        )

        # Suspicious Input Transformation Template
        self.templates["input-transformation"] = VulnerabilityTemplate(
            id="input-transformation",
            name="Suspicious Input Transformation",
            severity="medium",
            description="Detects suspicious input transformations that may indicate vulnerabilities",
            tags=["transformation", "filter", "bypass"],
            classification={"cve-id": None, "cwe-id": "CWE-20"},
            matchers=[
                {
                    "type": "regex",
                    "regex": ["7\\*7.*49", "\\\\\\\\.*\\\\", "<.*>.*&lt;.*&gt;"],
                    "part": "body"
                }
            ],
            info={"name": "Input Transformation", "author": "active-scan-plus-plus", "severity": "medium"}
        )

        # Blind Code Injection Template
        self.templates["blind-code-injection"] = VulnerabilityTemplate(
            id="blind-code-injection",
            name="Blind Code Injection",
            severity="high",
            description="Detects blind code injection via expression language, Ruby open(), Perl open()",
            tags=["code-injection", "blind", "rce"],
            classification={"cve-id": None, "cwe-id": "CWE-94"},
            matchers=[
                {
                    "type": "regex",
                    "regex": ["\\$\\{.*\\}", "`.*`", "system\\(.*\\)", "exec\\(.*\\)"],
                    "part": "body"
                }
            ],
            info={"name": "Blind Code Injection", "author": "active-scan-plus-plus", "severity": "high"}
        )

    def add_template(self, template: VulnerabilityTemplate):
        """Add a new vulnerability template."""
        self.templates[template.id] = template

    def scan_url(self, url: str, template_ids: Optional[List[str]] = None) -> List[Dict]:
        """Scan a URL with specified templates."""
        findings = []
        
        try:
            response = requests.get(url, timeout=10, verify=False)
            response_text = response.text
            response_headers = dict(response.headers)
            
            templates_to_check = template_ids or list(self.templates.keys())
            
            for template_id in templates_to_check:
                if template_id not in self.templates:
                    continue
                
                template = self.templates[template_id]
                matches = self._check_matchers(template.matchers, response_text, response_headers)
                
                if matches:
                    findings.append({
                        "template_id": template_id,
                        "template_name": template.name,
                        "severity": template.severity,
                        "url": url,
                        "matches": matches,
                        "info": template.info
                    })
        
        except Exception as e:
            findings.append({
                "error": str(e),
                "url": url
            })
        
        return findings

    def _check_matchers(self, matchers: List[Dict], body: str, headers: Dict) -> List[Dict]:
        """Check if matchers find patterns in response."""
        matches = []
        
        for matcher in matchers:
            matcher_type = matcher.get("type")
            part = matcher.get("part", "body")
            
            if part == "body":
                content = body
            elif part == "header":
                content = json.dumps(headers)
            else:
                content = body
            
            if matcher_type == "word":
                words = matcher.get("words", [])
                for word in words:
                    if word in content:
                        matches.append({
                            "type": "word",
                            "matched": word,
                            "part": part
                        })
            
            elif matcher_type == "regex":
                patterns = matcher.get("regex", [])
                for pattern in patterns:
                    if re.search(pattern, content, re.IGNORECASE):
                        matches.append({
                            "type": "regex",
                            "matched": pattern,
                            "part": part
                        })
        
        return matches

    def generate_template_from_cve(self, cve_id: str, patterns: List[str]) -> VulnerabilityTemplate:
        """Generate a template from CVE information."""
        return VulnerabilityTemplate(
            id=f"cve-{cve_id.lower()}",
            name=f"{cve_id} Detection",
            severity="high",
            description=f"Detection template for {cve_id}",
            tags=["cve", cve_id],
            classification={"cve-id": cve_id},
            matchers=[
                {
                    "type": "word",
                    "words": patterns,
                    "part": "body"
                }
            ],
            info={"name": f"{cve_id} Detection", "author": "PyAgent", "severity": "high"}
        )