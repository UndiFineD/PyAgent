from typing import List, Dict, Any, Optional, Union
from dataclasses import dataclass, field
import base64


@dataclass
class MultimodalChunk:
    ""
Represents a piece of interleaved data (text, audio, image).""
type: str  # "text", "audio_token", "image_patch"
    content: Union[str, bytes]
    metadata: Dict[str, Any] = field(default_factory=dict)


class MultimodalCore:
    ""
Lightweight multimodal core used in tests.

    Provides methods to append text/audio/image chunks and to generate a
    simple interleaved prompt representation for model input.
    ""
def __init__(self):
        self.context_sequence: List[MultimodalChunk] = []

    def add_text(self, text: str) -> None:
        self.context_sequence.append(MultimodalChunk(type="text", content=text))

    def add_audio_token(self, token: str, timestamp_ms: float) -> None:
        self.context_sequence.append(MultimodalChunk(type="audio_token", content=token, metadata={"timestamp": timestamp_ms}))

    def add_image_patch(self, image_bytes: bytes, bbox: Optional[List[int]] = None) -> None:
        b64_img = base64.b64encode(image_bytes).decode("utf-8")
        self.context_sequence.append(MultimodalChunk(type="image_patch", content=b64_img, metadata={"bbox": bbox} if bbox else {}))

    def generate_interleaved_prompt(self, model_family: str = "omni") -> str:
        parts: List[str] = []
        for chunk in self.context_sequence:
            if chunk.type == "text":
                parts.append(str(chunk.content))
            elif chunk.type == "audio_token":
                parts.append(f"<|audio|>{chunk.content}<|/audio|>")
            elif chunk.type == "image_patch":
                parts.append(f"<|image|>{chunk.content}<|/image|>")
        return "".join(parts)

    def clear(self) -> None:
        self.context_sequence = []

    async def sync_streams(self, audio_receiver: Any, video_receiver: Any) -> None:
        ""
Skeleton for synchronizing audio/video streams in tests.""
        # No-op for tests
        return None

    def get_token_count(self) -> int:
        count = 0
        for chunk in self.context_sequence:
            if chunk.type == "text":
                count += max(1, len(str(chunk.content)) // 4)
            else:
                count += 128
        return count
