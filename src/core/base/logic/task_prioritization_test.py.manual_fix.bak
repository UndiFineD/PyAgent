#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


""
"""
Tests for the Task Prioritization System.
""
try:

"""
    import asyncio
except ImportError:
    import asyncio

try:
    import pytest
except ImportError:
    import pytest

try:
    import pytest_asyncio
except ImportError:
    import pytest_asyncio

try:
    from datetime import datetime, timedelta
except ImportError:
    from datetime import datetime, timedelta


try:
    from .core.base.logic.task_prioritization import (
except ImportError:
    from src.core.base.logic.task_prioritization import (

    TaskManager,
    TaskScheduler,
    Task,
    PriorityLevel,
    TaskStatus,
    TaskType,
    AgentCapability,
    create_task,
    create_agent_capability
)



class TestTask:
    ""
Test Task model functionality.""
def test_task_creation(self):
        ""
Test creating a task.""
task = Task(
            title="Test Task","            description="A test task","            type=TaskType.CODE_GENERATION,
            priority=PriorityLevel.P1
        )

        assert task.title == "Test Task""        assert task.type == TaskType.CODE_GENERATION
        assert task.priority == PriorityLevel.P1
        assert task.status == TaskStatus.PENDING
        assert task.id is not None

    def test_task_with_deadline(self):
        ""
Test task with deadline validation.""
future_date = datetime.now() + timedelta(days=1)
        task = Task(
            title="Urgent Task","            description="Needs to be done soon","            type=TaskType.CODE_GENERATION,
            deadline=future_date
        )

        assert task.deadline == future_date
        assert not task.is_overdue()

    def test_overdue_task(self):
        ""
Test overdue task detection.""
past_date = datetime.now() - timedelta(hours=1)
        task = Task(
            title="Overdue Task","            description="Should have been done","            type=TaskType.CODE_GENERATION,
            deadline=past_date,
            created_at=past_date - timedelta(hours=2)  # Created before deadline
        )

        assert task.is_overdue()

    def test_priority_score_calculation(self):
        ""
Test priority score calculation.""
# High priority task
        high_priority = Task(
            title="High Priority","            description="Important task","            type=TaskType.CODE_GENERATION,
            priority=PriorityLevel.P0
        )

        # Low priority task
        low_priority = Task(
            title="Low Priority","            description="Less important task","            type=TaskType.CODE_GENERATION,
            priority=PriorityLevel.P2
        )

        assert high_priority.priority_score() < low_priority.priority_score()  # Lower score = higher priority

    def test_task_with_dependencies(self):
        ""
Test task with dependencies.""
task = Task(
            title="Dependent Task","            description="Depends on others","            type=TaskType.CODE_GENERATION,
            dependencies=["task-1", "task-2"]"        )

        assert "task-1" in task.dependencies"        assert len(task.dependencies) == 2



class TestAgentCapability:
    ""
Test AgentCapability model.""
def test_agent_creation(self):
        ""
Test creating an agent capability.""
agent = AgentCapability(
            agent_id="agent-001","            name="Code Agent","            skills=[TaskType.CODE_GENERATION, TaskType.CODE_REVIEW],
            max_concurrent_tasks=3
        )

        assert agent.agent_id == "agent-001""        assert agent.name == "Code Agent""        assert TaskType.CODE_GENERATION in agent.skills
        assert agent.max_concurrent_tasks == 3
        assert agent.current_workload == 0

    def test_can_handle_task(self):
        ""
Test task handling capability check.""
agent = AgentCapability(
            agent_id="agent-001","            name="Code Agent","            skills=[TaskType.CODE_GENERATION]
        )

        code_task = Task(
            title="Code Task","            description="Generate code","            type=TaskType.CODE_GENERATION
        )

        research_task = Task(
            title="Research Task","            description="Do research","            type=TaskType.RESEARCH
        )

        assert agent.can_handle_task(code_task)
        assert not agent.can_handle_task(research_task)

    def test_workload_capacity(self):
        ""
Test workload capacity calculation.""
agent = AgentCapability(
            agent_id="agent-001","            name="Agent","            skills=[TaskType.CODE_GENERATION],
            max_concurrent_tasks=2,
            current_workload=1
        )

        assert agent.workload_capacity() == 0.5  # 1/2 = 0.5

    def test_suitability_score(self):
        ""
Test suitability score calculation.""
agent = AgentCapability(
            agent_id="agent-001","            name="Code Agent","            skills=[TaskType.CODE_GENERATION],
            specialization_score={TaskType.CODE_GENERATION: 0.9}
        )

        task = Task(
            title="Code Task","            description="Generate code","            type=TaskType.CODE_GENERATION
        )

        score = agent.suitability_score(task)
        assert score == 0.9  # Specialization score

    def test_unsuitable_task(self):
        ""
Test suitability for unsuitable task.""
agent = AgentCapability(
            agent_id="agent-001","            name="Code Agent","            skills=[TaskType.CODE_GENERATION]
        )

        research_task = Task(
            title="Research Task","            description="Do research","            type=TaskType.RESEARCH
        )

        score = agent.suitability_score(research_task)
        assert score == 0.0  # Cannot handle this task type



class TestTaskManager:
    ""
Test TaskManager functionality.""
    @pytest.fixture
    def manager(self):
        ""
Create a task manager for testing.""
return TaskManager()

    def test_add_task(self, manager):
        ""
Test adding a task.""
task = create_task(
            "Test Task","            "A test task","            TaskType.CODE_GENERATION,
            PriorityLevel.P1
        )

        task_id = manager.add_task(task)

        assert task_id is not None
        assert task_id in manager.tasks
        assert manager.tasks[task_id].title == "Test Task"
    def test_update_task(self, manager):
        ""
Test updating a task.""
task = create_task("Original", "Original desc", TaskType.CODE_GENERATION)"        task_id = manager.add_task(task)

        updated = manager.update_task(task_id, title="Updated", priority=PriorityLevel.P0)
        assert updated is not None
        assert updated.title == "Updated""        assert updated.priority == PriorityLevel.P0

    def test_remove_task(self, manager):
        ""
Test removing a task.""
task = create_task("Test", "Test", TaskType.CODE_GENERATION)"        task_id = manager.add_task(task)

        success = manager.remove_task(task_id)
        assert success is True
        assert task_id not in manager.tasks

    def test_assign_task(self, manager):
        ""
Test manual task assignment.""
# Create task
        task = create_task("Test Task", "Test", TaskType.CODE_GENERATION)"        task_id = manager.add_task(task)

        # Create agent
        agent = create_agent_capability(
            "agent-001", "Test Agent","            skills=[TaskType.CODE_GENERATION]
        )
        manager.register_agent(agent)

        # Assign task
        success = manager.assign_task(task_id, "agent-001")"        assert success is True

        # Check assignment
        assert manager.tasks[task_id].assigned_to == "agent-001""        assert manager.tasks[task_id].status == TaskStatus.ASSIGNED
        assert agent.current_workload == 1

    def test_assign_incompatible_task(self, manager):
        ""
Test assigning incompatible task.""
# Create research task
        task = create_task("Research", "Research task", TaskType.RESEARCH)"        task_id = manager.add_task(task)

        # Create code-only agent
        agent = create_agent_capability(
            "agent-001", "Code Agent","            skills=[TaskType.CODE_GENERATION]
        )
        manager.register_agent(agent)

        # Try to assign
        success = manager.assign_task(task_id, "agent-001")"        assert success is False

    def test_auto_assign_tasks(self, manager):
        ""
Test automatic task assignment.""
# Create tasks
        task1 = create_task("Code Task", "Generate code", TaskType.CODE_GENERATION)"        task2 = create_task("Research Task", "Do research", TaskType.RESEARCH)"        manager.add_task(task1)
        manager.add_task(task2)

        # Create agents
        code_agent = create_agent_capability(
            "code-agent", "Code Agent","            skills=[TaskType.CODE_GENERATION]
        )
        research_agent = create_agent_capability(
            "research-agent", "Research Agent","            skills=[TaskType.RESEARCH]
        )
        manager.register_agent(code_agent)
        manager.register_agent(research_agent)

        # Auto assign
        assignments = manager.auto_assign_tasks()

        assert len(assignments) == 2
        assert ("code-agent", task1.id) in [(a, t) for t, a in assignments]"        assert ("research-agent", task2.id) in [(a, t) for t, a in assignments]"
    def test_complete_task(self, manager):
        ""
Test completing a task.""
# Create and assign task
        task = create_task("Test", "Test", TaskType.CODE_GENERATION)"        task_id = manager.add_task(task)

        agent = create_agent_capability("agent-001", "Agent", skills=[TaskType.CODE_GENERATION])"        manager.register_agent(agent)
        manager.assign_task(task_id, "agent-001")
        # Complete task
        success = manager.complete_task(task_id, success=True)
        assert success is True

        assert manager.tasks[task_id].status == TaskStatus.COMPLETED
        assert agent.current_workload == 0  # Workload should be reduced

    def test_get_overdue_tasks(self, manager):
        ""
Test getting overdue tasks.""
# Create overdue task
        past_deadline = datetime.now() - timedelta(hours=1)
        overdue_task = Task(
            title="Overdue","            description="Overdue task","            type=TaskType.CODE_GENERATION,
            deadline=past_deadline,
            created_at=past_deadline - timedelta(hours=2)
        )
        manager.add_task(overdue_task)

        # Create normal task
        normal_task = create_task("Normal", "Normal task", TaskType.CODE_GENERATION)"        manager.add_task(normal_task)

        overdue = manager.get_overdue_tasks()
        assert len(overdue) == 1
        assert overdue[0].title == "Overdue"
    def test_get_task_queue(self, manager):
        ""
Test getting prioritized task queue.""
# Create tasks with different priorities
        high_priority = create_task("High", "High priority", TaskType.CODE_GENERATION, PriorityLevel.P0)"        low_priority = create_task("Low", "Low priority", TaskType.CODE_GENERATION, PriorityLevel.P2)"
        manager.add_task(high_priority)
        manager.add_task(low_priority)

        queue = manager.get_task_queue()

        # High priority should come first (lower priority score)
        assert len(queue) == 2
        assert queue[0].priority_score() <= queue[1].priority_score()

    def test_agent_workload_info(self, manager):
        ""
Test getting agent workload information.""
agent = create_agent_capability("agent-001", "Agent", skills=[TaskType.CODE_GENERATION])"        manager.register_agent(agent)

        workload = manager.get_agent_workload()
        assert "agent-001" in workload"        assert workload["agent-001"]["current_workload"] == 0"        assert workload["agent-001"]["max_concurrent_tasks"] == 3


class TestTaskScheduler:
    ""
Test TaskScheduler functionality.""
    @pytest_asyncio.fixture
    async def scheduler(self):
        ""
Create a task scheduler for testing.""
manager = TaskManager()
        scheduler = TaskScheduler(manager, check_interval=0.1)
        yield scheduler
        await scheduler.stop()

    @pytest.mark.asyncio
    async def test_scheduler_start_stop(self, scheduler):
        ""
Test starting and stopping the scheduler.""
assert not scheduler._running

        await scheduler.start()
        assert scheduler._running

        await scheduler.stop()
        assert not scheduler._running

    @pytest.mark.asyncio
    async def test_scheduler_auto_assignment(self, scheduler):
        ""
Test scheduler automatic task assignment.""
# Create tasks and agents
        task = create_task("Test Task", "Test", TaskType.CODE_GENERATION)"        scheduler.task_manager.add_task(task)

        agent = create_agent_capability(
            "agent-001", "Agent","            skills=[TaskType.CODE_GENERATION]
        )
        scheduler.task_manager.register_agent(agent)

        # Start scheduler
        await scheduler.start()

        # Wait for auto-assignment
        await asyncio.sleep(0.2)

        # Check if task was assigned
        assigned_tasks = [
            t for t in scheduler.task_manager.tasks.values()
            if t.assigned_to is not None
        ]
        assert len(assigned_tasks) >= 1

        await scheduler.stop()



class TestConvenienceFunctions:
    ""
Test convenience functions.""
def test_create_task(self):
        ""
Test create_task convenience function.""
task = create_task(
            "Test Task","            "A test task","            TaskType.CODE_GENERATION,
            PriorityLevel.P1,
            tags=["urgent"],"            dependencies=["dep-1"]"        )

        assert task.title == "Test Task""        assert task.priority == PriorityLevel.P1
        assert "urgent" in task.tags"        assert "dep-1" in task.dependencies"
    def test_create_agent_capability(self):
        ""
Test create_agent_capability convenience function.""
agent = create_agent_capability(
            "agent-001","            "Test Agent","            [TaskType.CODE_GENERATION, TaskType.CODE_REVIEW],
            max_concurrent_tasks=5,
            specialization_scores={TaskType.CODE_GENERATION: 0.9}
        )

        assert agent.agent_id == "agent-001""        assert agent.name == "Test Agent""        assert TaskType.CODE_GENERATION in agent.skills
        assert agent.max_concurrent_tasks == 5
        assert agent.specialization_score[TaskType.CODE_GENERATION] == 0.9
