#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from typing import Dict, Any


class ExploitIntelligence:
    """Intelligence engine for tracking CVEs, PoCs, and exploitation primitives."""

    @staticmethod
    def get_recent_cves() -> Dict[str, Any]:
        """Metadata and primitives for recent high-impact CVEs (2024-2025)."""
        return {
            "CVE-2025-21204": {
                "name": "Update Stack Junction Path Hijack",
                "target": r"C:\ProgramData\Microsoft\UpdateStack\Tasks",
                "method": ("Junction-based hijacking of Update Stack to gain SYSTEM execution via MoUsoCoreWorker.exe"),
                "impact": "Privilege Escalation (LPE)",
                "primitives": ["mklink /J"],
            },
            "CVE-2025-21293": {
                "name": "RPC Endpoint Mapper / Performance Data DLL Hijack",
                "method": (
                    "Leveraging vulnerable registry permissions to hijack performance data "
                    "collection DLLs (OpenPerfData/CollectPerfData)"
                ),
                "impact": "Privilege Escalation",
                "primitives": ["DLL Sideloading", "Registry Hijacking"],
            },
            "CVE-2024-BYOB-RCE": {
                "name": "BYOB v2.0.0 Unauthenticated RCE",
                "method": (
                    "Database overwrite via spoofed agent callback followed by command injection in payload builder"
                ),
                "target_app": "Build Your Own Botnet (BYOB)",
                "primitives": ["SQLite Overwrite", "Command Injection"],
            },
        }

    @staticmethod
    def get_vuln_scanning_logic() -> Dict[str, str]:
        """Code logic for identifying vulnerable states (Ported from recent PoCs)."""
        return {
            "registry_permission_audit": (
                "Traversing registry keys to find SIDs that allow Write/FullControl for non-admin principals"
            ),
            "junction_target_check": (
                "Verifying if critical service paths (like UpdateStack) are missing or writable by users"
            ),
            "uac_auto_elevate_discovery": (
                "Searching for binaries with autoElevate=true in their manifest for UAC bypass potential"
            ),
            "xss_reflection_certainty": (
                "Measuring XSS potential by checking if test_char + identifier is reflected at start/end "
                "of response body"
            ),
            "bitlocker_fve_parsing": "Extracting VolumeGuid and CreatedAt from distinguishedName of msFVE objects",
        }

    @staticmethod
    def get_xss_fuzzing_primitives() -> Dict[str, Any]:
        """Discovery patterns and characters for XSS detection."""
        return {
            "test_chars": ["'", '"', "<", ">", ";", "\\"],
            "reflection_fingerprint": "{id}{char}{id[:2]}",
            "headers": ["User-Agent", "Referer", "X-Forwarded-For", "Cookie"],
            "parameters": ["id", "q", "s", "search", "lang", "redirect", "url"],
        }

    @staticmethod
    def get_binary_exploitation_gadgets() -> Dict[str, Any]:
        """Gadgets and shellcode stubs for memory corruption (Ported from fastoverflowtk)."""
        return {
            "egghunters": {
                "nt_display": {
                    "bytes": b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8"
                    b"\x54\x30\x30\x57\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7",
                    "egg": "T00W",
                    "platform": "Windows x86",
                }
            },
            "seh_bypass": {"next_seh": b"\xeb\x06\x90\x90", "method": "PPR (Pop Pop Ret)"},
            "jmp_esp_gadgets": {"general": "0xFFE4", "search_pattern": "push esp; ret|jmp esp"},
        }
