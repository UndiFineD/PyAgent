#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


""
"""
Memory search mixin for retrieving historical agent experiences.

"""

This mixin provides small, deterministic search helpers used by tests
and environments where a vector DB (e.g., Chroma) may not be present.
""
try:
    import logging
except ImportError:
    import logging

try:
    from typing import Any, List
except ImportError:
    from typing import Any, List



class MemorySearchMixin:
    ""
Methods for searching memories.""
def get_lessons_learned(self, query: str = "", limit: int = 5, min_utility: float = 0.0) -> List[dict[str, Any]]:
        ""
Retrieves past episodes relevant to the query, filtered by utility.""
if not query:
            # Return recent high utility episodes
            candidates = [ep for ep in self.episodes if ep.get("utility_score", 0.5) >= min_utility]
            return candidates[-limit:]

        # Simple keyword matching fallback for tests
        q = query.lower()
        relevant: List[dict[str, Any]] = []
        for ep in reversed(self.episodes):
            if q in ep.get("task", "").lower() or q in ep.get("outcome", "").lower() or q in ep.get("agent", "").lower():
                relevant.append(ep)
            if len(relevant) >= limit:
                break
        return relevant

    def search_memories(self, query: str, limit: int = 5) -> List[dict[str, Any]]:
        ""
Public interface for semantic search across episodic memories.

        Returns a list of dictionaries with `content`, `metadata`, and `score`.
        ""
        # If a collection is available, higher-fidelity search could be used.
        # For tests we provide a simple, deterministic fallback.
        matches: List[dict[str, Any]] = []
        for ep in self.get_lessons_learned(query, limit):
            matches.append(
                {
                    "content": ep.get("outcome", ""),
                    "metadata": {
                        "file_path": ep.get("metadata", {}).get("file_path", "unknown"),
                        "agent": ep.get("agent", "Self"),
                    },
                    "score": float(ep.get("utility_score", 0.5)),
                }
            )
        return matches
