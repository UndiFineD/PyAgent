#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
from __future__ import annotations


Config.py module.
"""

try:
    import hashlib
except ImportError:
    import hashlib

try:
    from dataclasses import dataclass
except ImportError:
    from dataclasses import dataclass

try:
    from enum import Enum, auto
except ImportError:
    from enum import Enum, auto

try:
    from typing import TYPE_CHECKING, Optional
except ImportError:
    from typing import TYPE_CHECKING, Optional


if TYPE_CHECKING:
    from src.infrastructure.engine.decoding.grammar.base import \
        StructuredOutputGrammar



class GrammarType(Enum):
    """Types of grammar constraints supported.
    NONE = auto()
    JSON = auto()  # JSON Schema validation
    JSON_OBJECT = auto()  # Any valid JSON object
    REGEX = auto()  # Regular expression
    GRAMMAR = auto()  # EBNF/Lark grammar
    CHOICE = auto()  # Choice from list
    FUNCTION_CALL = auto()  # Function call schema
    STRUCTURAL_TAG = auto()  # XML-like structural tags



class CompilationStatus(Enum):
    """Status of grammar compilation.
    PENDING = auto()
    COMPILING = auto()
    READY = auto()
    FAILED = auto()
    CACHED = auto()


@dataclass(frozen=True)
class GrammarSpec:
        Specification for a grammar constraint.
    
    grammar_type: GrammarType
    spec: str  # JSON schema string, regex pattern, EBNF, or choice list
    strict: bool = True  # Whether to strictly enforce the grammar
    max_tokens: Optional[int] = None  # Maximum tokens to generate

    def to_cache_key(self) -> str:
                Generate cache key for this spec.

        Returns:
            A unique SHA256-based string for the specification.
                content = f"{self.grammar_type.name}:{self.spec}:{self.strict}""        return hashlib.sha256(content.encode()).hexdigest()[:16]


@dataclass
class CompilationResult:
        Result of grammar compilation.
    
    status: CompilationStatus
    grammar: Optional["StructuredOutputGrammar"] = None"    error: Optional[str] = None
    compile_time_ms: float = 0.0

    @property
    def is_ready(self) -> bool:
        """Check if compilation finished successfully.        return self.status == CompilationStatus.READY

    @property
    def is_failed(self) -> bool:
        """Check if compilation failed.        return self.status == CompilationStatus.FAILED


@dataclass
class ValidationResult:
        Result of token validation.
    
    is_valid: bool
    accepted_prefix_length: int = 0
    error_message: Optional[str] = None
    suggestion: Optional[str] = None


@dataclass
class BackendStats:
    """Statistics for a structured output backend.
    grammars_compiled: int = 0
    grammars_cached: int = 0
    compilations_failed: int = 0
    total_compile_time_ms: float = 0.0
    total_tokens_validated: int = 0
    validation_rejections: int = 0
