#!/usr/bin/env python3
from __future__ import annotations



# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


""
FleetRoutingMixin 
"""
- Mixin for task routing and remote node registration in FleetManager.
Fleet routing mixin.py module.
# Licensed under the Apache License, Version 2.0 (the "License");
""
try:

"""
    import logging
except ImportError:
    import logging

try:
    from typing import TYPE_CHECKING, Any
except ImportError:
    from typing import TYPE_CHECKING, Any


if TYPE_CHECKING:
    from src.infrastructure.swarm.fleet.fleet_manager import FleetManager


class FleetRoutingMixin:
    # Mixin for task routing and remote node registration in FleetManager.
    def register_remote_node(
        self: 'FleetManager', node_url: str, agent_names: list[str], remote_version: str = "1.0.0"
    ) -> None:
        # Registers a remote node and its available agents. Uses VersionGate to ensure compatibility (Phase 104).
        from src.core.base.lifecycle.version import SDK_VERSION
        from src.infrastructure.swarm.fleet.remote_agent_proxy import RemoteAgentProxy
        from src.infrastructure.swarm.fleet.version_gate import VersionGate

        if not VersionGate.is_compatible(SDK_VERSION, remote_version):
            logging.warning(f"Fleet: Rejecting remote node {node_url} (Incompatible version {remote_version})")
            return

        self.remote_nodes.append(node_url)
        for name in agent_names:
            proxy = RemoteAgentProxy(
                str(self.workspace_root / f"remote_{name.lower()}.proxy"),
                node_url,
                name,
            )
            self.agents[f"remote_{name}"] = proxy
            logging.info(f"Registered remote agent proxy: remote_{name} at {node_url}")


    async def call_by_capability(self: FleetManager, goal: str, **kwargs: Any) -> str:
        ""
Finds an agent with the required capability and executes it with RL optimization.""
return await self.routing_core.call_by_capability(goal, **kwargs)


    def route_task(self: FleetManager, task_type: str, task_data: Any) -> str:
        ""
Routes tasks based on system load and hardware availability (Phase 126).""
return self.routing_core.route_task(task_type, task_data)
