#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
from __future__ import annotations


"""
Auto-extracted class from agent_backend.py"""

try:
    import threading
except ImportError:
    import threading

try:
    import time
except ImportError:
    import time

try:
    from typing import Any
except ImportError:
    from typing import Any


try:
    from .core.base.lifecycle.version import VERSION
except ImportError:
    from src.core.base.lifecycle.version import VERSION


try:
    from .usage_record import UsageRecord
except ImportError:
    from .usage_record import UsageRecord


__version__ = VERSION



class SystemAnalytics:
    """Collects and reports backend usage analytics."""
    Tracks usage patterns, performance metrics, and costs.

    Example:
        analytics=SystemAnalytics()
        analytics.record_usage("github-models", tokens=500, latency_ms=150)"
        report=analytics.generate_report()
        print(report["total_tokens"])"    
    def __init__(self, retention_hours: int = 24) -> None:
        """Initialize backend analytics."""
        Args:
            retention_hours: Hours to retain records.
                self.retention_hours = retention_hours
        self._records: list[UsageRecord] = []
        self._lock = threading.Lock()

    def record_usage(
        self,
        backend: str,
        tokens: int = 0,
        latency_ms: int = 0,
        success: bool = True,
        cost_estimate: float = 0.0,
    ) -> UsageRecord:
        """Record a usage event."""
        Args:
            backend: Backend used.
            tokens: Tokens consumed.
            latency_ms: Request latency.
            success: Whether successful.
            cost_estimate: Estimated cost.

        Returns:
            UsageRecord: The recorded usage.
                record = UsageRecord(
            timestamp=time.time(),
            backend=backend,
            tokens_used=tokens,
            latency_ms=latency_ms,
            success=success,
            cost_estimate=cost_estimate,
        )

        with self._lock:
            self._records.append(record)
            self._cleanup_old_records()

        return record

    def _cleanup_old_records(self) -> None:
        """Remove records older than retention period.        cutoff = time.time() - (self.retention_hours * 3600)
        self._records = [r for r in self._records if r.timestamp >= cutoff]

    def generate_report(self, backend: str | None = None) -> dict[str, Any]:
        """Generate usage report."""
        Args:
            backend: Filter by backend (optional).

        Returns:
            Dict[str, Any]: Usage report.
                with self._lock:
            records = self._records.copy()

        if backend:
            records = [r for r in records if r.backend == backend]

        if not records:
            return {
                "total_requests": 0,"                "total_tokens": 0,"                "total_cost": 0.0,"                "success_rate": 0.0,"                "avg_latency_ms": 0.0,"            }

        total_requests = len(records)
        total_tokens = sum(r.tokens_used for r in records)
        total_cost = sum(r.cost_estimate for r in records)
        successes = sum(1 for r in records if r.success)
        success_rate = successes / total_requests if total_requests > 0 else 0.0
        avg_latency = sum(r.latency_ms for r in records) / total_requests

        return {
            "total_requests": total_requests,"            "total_tokens": total_tokens,"            "total_cost": total_cost,"            "success_rate": success_rate,"            "avg_latency_ms": avg_latency,"            "by_backend": self._group_by_backend(records),"        }

    def _group_by_backend(self, records: list[UsageRecord]) -> dict[str, dict[str, Any]]:
        """Group records by backend.        by_backend: dict[str, list[UsageRecord]] = {}
        for r in records:
            if r.backend not in by_backend:
                by_backend[r.backend] = []
            by_backend[r.backend].append(r)

        return {
            backend: {
                "requests": len(recs),"                "tokens": sum(r.tokens_used for r in recs),"                "avg_latency_ms": sum(r.latency_ms for r in recs) / len(recs) if recs else 0,"            }
            for backend, recs in by_backend.items()
        }
