#!/usr/bin/env python3
# Copyright 2026 PyAgent Authors
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import pytest
import asyncio
from unittest.mock import Mock, patch
from src.core.base.mixins.vulnerability_scanner_mixin import VulnerabilityScannerMixin


class TestVulnerabilityScannerMixin:
    """Test cases for VulnerabilityScannerMixin."""
    
    def setup_method(self):
        self.mixin = VulnerabilityScannerMixin()
        
    def test_register_check(self):
        """Test registering vulnerability checks."""
        def dummy_check(base_url, my_host, debug, proxy):
            return []
            
        self.mixin.register_vulnerability_check('test_check', dummy_check)
        assert 'test_check' in self.mixin.get_registered_checks()
        
    def test_unregister_check(self):
        """Test unregistering checks."""
        def dummy_check(base_url, my_host, debug, proxy):
            return []
            
        self.mixin.register_vulnerability_check('test_check', dummy_check)
        self.mixin.unregister_vulnerability_check('test_check')
        assert 'test_check' not in self.mixin.get_registered_checks()
        
    @patch('src.core.base.mixins.vulnerability_scanner_mixin.requests.request')
    def test_run_scan_no_checks(self, mock_request):
        """Test running scan with no registered checks."""
        async def run():
            results = await self.mixin.run_vulnerability_scan('http://example.com')
            assert results == []
            
        asyncio.run(run())
        
    @patch('src.core.base.mixins.vulnerability_scanner_mixin.requests.request')
    def test_run_scan_with_checks(self, mock_request):
        """Test running scan with registered checks."""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.content.decode.return_value = '{"test": "data"}'
        mock_request.return_value = mock_response
        
        def test_check(base_url, my_host, debug, proxy):
            from src.core.base.mixins.vulnerability_scanner_mixin import Finding
            return [Finding('test_vuln', f'{base_url}/test', 'Test vulnerability')]
            
        self.mixin.register_vulnerability_check('test', test_check)
        
        async def run():
            results = await self.mixin.run_vulnerability_scan('http://example.com')
            assert len(results) == 1
            assert results[0].name == 'test_vuln'
            
        asyncio.run(run())
        
    def test_random_string(self):
        """Test random string generation."""
        s1 = self.mixin.random_string(10)
        s2 = self.mixin.random_string(10)
        assert len(s1) == 10
        assert len(s2) == 10
        assert s1 != s2  # Should be different
        
    def test_normalize_url(self):
        """Test URL normalization."""
        # Normal case
        url = self.mixin.normalize_url('http://example.com', '/test')
        assert url == 'http://example.com/test'
        
        # Triple slash bypass
        url = self.mixin.normalize_url('http://example.com', '///test')
        assert url == 'http://example.com/test'
